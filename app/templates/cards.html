{% extends "base.html" %}
{% block title %}Browse cards · MTG Friends Trades{% endblock %}
{% block content %}
<div class="max-w-xl mx-auto">
  <h1 class="text-2xl font-semibold mb-4">Browse all cards</h1>

  <form method="get" action="/cards"
        class="flex flex-col md:flex-row gap-3 mb-4 items-stretch md:items-end">
    <div class="flex-1">
      <label class="block text-sm mb-1">Search by card name</label>
      <div class="relative">
        <input id="cards-q"
               name="q"
               value="{{ q or '' }}"
               data-card-autocomplete="true"
               class="w-full rounded bg-slate-900 border border-slate-600 px-3 py-2 text-sm"
               placeholder="Search by card name">
        <div class="absolute z-30 mt-1 w-full bg-slate-900 border border-slate-700 rounded-md shadow-lg hidden text-xs max-h-56 overflow-y-auto"
             data-card-suggestions-for="cards-q"></div>
      </div>
    </div>

    {% if current_user and groups %}
      <div class="md:w-40">
        <label class="block text-sm mb-1">Group</label>
        <select name="group_id"
                class="w-full rounded bg-slate-900 border border-slate-600 px-3 py-2 text-sm">
          <option value="">All my groups</option>
          {% for g in groups %}
            <option value="{{ g.id }}"
                    {% if group_id and g.id == group_id|int %}selected{% endif %}>
              {{ g.name }}
            </option>
          {% endfor %}
        </select>
      </div>
    {% endif %}

    <div class="md:w-28">
      <label class="block text-sm mb-1 invisible md:visible md:h-5">Search</label>
      <button type="submit"
              class="w-full px-4 py-2 rounded bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold text-sm">
        Search
      </button>
    </div>
  </form>
</div>


{% if current_user %}
  <p class="text-xs text-slate-400 mb-4">
    Logged in as <span class="font-semibold">{{ current_user.name }}</span>.
    <a href="/dashboard" class="text-emerald-400 hover:text-emerald-300">Go to my cards.</a>
  </p>
{% else %}
  <p class="text-xs text-slate-400 mb-4">
    You’re browsing as guest. <a href="/login" class="text-emerald-400 hover:text-emerald-300">Log in</a> to add your own cards.
  </p>
{% endif %}

{% if cards %}
  <div class="space-y-3">
    {% for item in cards %}
      {% set c = item.card %}
      {% set o = item.owner %}
      <div class="border border-slate-700 rounded-md p-2 mb-2 bg-slate-800/60">
        <div class="flex gap-3 items-start">
          <div class="w-20">
            {% if c.scryfall_image_url %}
              <img src="{{ c.scryfall_image_url }}" alt="{{ c.card_name }}"
                   class="w-20 h-28 object-cover rounded border border-slate-700 cursor-pointer"
                   onclick="openCardModal('{{ c.scryfall_image_url }}', '{{ c.card_name|e }}')">
            {% else %}
              <div class="w-20 h-28 flex items-center justify-center rounded bg-slate-900 text-[10px] text-slate-500">
                no image
              </div>
            {% endif %}
          </div>
          <div class="flex-1 text-sm">
            <div 
              {% if c.scryfall_image_url %}
                <div class="font-semibold cursor-pointer"
                     onclick="openCardModal('{{ c.scryfall_image_url }}', '{{ c.card_name|e }}')">
                  {{ c.card_name }}
                </div>
              {% else %}
                <div class="font-semibold">
                  {{ c.card_name }}
                </div>
              {% endif %}
          </div>
            <div class="text-xs text-slate-400">
              {% if c.set_name %}Set: {{ c.set_name }} · {% endif %}
              Qty: {{ c.quantity }}{% if c.foil %} · Foil{% endif %}{% if c.condition %} · {{ c.condition }}{% endif %}
            </div>

            {% if c.price_usd %}
              <div class="text-[11px] text-emerald-300 mt-0.5">
                ~${{ "%.2f"|format(c.price_usd) }} each
                {% if c.quantity > 1 %}
                  · total ~${{ "%.2f"|format(c.price_usd * c.quantity) }}
                {% endif %}
              </div>
            {% endif %}
          </div>
          <div class="w-40 text-xs text-right">
            <div class="font-semibold text-slate-200">
              {{ o.name }}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p class="text-sm text-slate-400">
    No cards match your search yet. Try different text or ask your friends to add their cards.
  </p>
{% endif %}
{% endblock %}
