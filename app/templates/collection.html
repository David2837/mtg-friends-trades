{% extends "base.html" %}
{% block title %}Collection · MTG Friends Trades{% endblock %}

{% block content %}
{% set has_filters = (q or listed != 'all' or color != 'any' or card_type != 'any' or sort != 'name_asc') %}
<h1 class="text-2xl font-semibold mb-4">My collection</h1>

{% if has_filters %}
  <div class="mb-3 flex flex-wrap gap-2 text-[11px]">
    <span class="px-2 py-0.5 rounded-full bg-slate-900 border border-slate-700 text-slate-200">
      Active filters:
    </span>
    {% if q %}
      <span class="px-2 py-0.5 rounded-full bg-slate-900 border border-slate-700 text-slate-100">
        Name: “{{ q }}”
      </span>
    {% endif %}
    {% if listed != 'all' %}
      <span class="px-2 py-0.5 rounded-full bg-slate-900 border border-slate-700 text-slate-100">
        {% if listed == 'listed' %}Listed only{% else %}Not listed{% endif %}
      </span>
    {% endif %}
    {% if color != 'any' %}
      <span class="px-2 py-0.5 rounded-full bg-slate-900 border border-slate-700 text-slate-100">
        Color: {{ color }}
      </span>
    {% endif %}
    {% if card_type != 'any' %}
      <span class="px-2 py-0.5 rounded-full bg-slate-900 border border-slate-700 text-slate-100">
        Type: {{ card_type }}
      </span>
    {% endif %}
    {% if sort != 'name_asc' %}
      <span class="px-2 py-0.5 rounded-full bg-slate-900 border border-slate-700 text-slate-100">
        {% if sort == 'name_desc' %}Name Z → A
        {% elif sort == 'price_desc' %}Price high → low
        {% elif sort == 'price_asc' %}Price low → high
        {% elif sort == 'set_asc' %}Set, then name
        {% endif %}
      </span>
    {% endif %}
  </div>
{% endif %}


{% set removed_name = request.query_params.get('removed_name') %}
{% set removed_qty = request.query_params.get('removed_qty') %}

{% if removed_name and removed_qty %}
  <div class="mb-3 text-xs rounded bg-rose-900/70 border border-rose-600/70 px-3 py-2">
    <span class="text-rose-50">
      Removed <strong>{{ removed_qty }}</strong> cop{% if removed_qty|int == 1 %}y{% else %}ies{% endif %}
      of <strong>{{ removed_name }}</strong> from your collection.
      {% if request.query_params.get('removed_all') %}
        All copies of this card were removed.
      {% endif %}
    </span>
  </div>
{% endif %}



{% set c_added = request.query_params.get('csv_import_added') %}
{% set c_updated = request.query_params.get('csv_import_updated') %}
{% set c_skipped = request.query_params.get('csv_import_skipped') %}

{% if c_added or c_updated or c_skipped %}
  <div class="mb-3 text-xs rounded bg-slate-900/80 border border-slate-600/60 px-3 py-2">
    <div class="text-slate-100 mb-1 font-semibold">
      Collection import summary
    </div>
    <ul class="list-disc list-inside text-slate-200">
      {% if c_added and c_added|int > 0 %}
        <li>{{ c_added }} new card row{% if c_added|int != 1 %}s{% endif %} added to your collection.</li>
      {% endif %}
      {% if c_updated and c_updated|int > 0 %}
        <li>{{ c_updated }} existing card row{% if c_updated|int != 1 %}s{% endif %} had their quantity increased.</li>
      {% endif %}
      {% if c_skipped and c_skipped|int > 0 %}
        <li>{{ c_skipped }} CSV row{% if c_skipped|int != 1 %}s{% endif %} skipped (empty or invalid name).</li>
      {% endif %}
    </ul>
  </div>
{% endif %}

{% if request.query_params.get('collection_cleared') %}
  <div class="mb-3 text-xs rounded bg-rose-900/70 border border-rose-600/70 px-3 py-2">
    <span class="text-rose-50">
      Your entire collection has been deleted.
    </span>
  </div>
{% endif %}



{% if request.query_params.get('added_new') %}
  <div class="mb-3 text-xs rounded bg-emerald-900/70 border border-emerald-600/60 px-3 py-2">
    Added <strong>{{ request.query_params.get('added_new') }}</strong> to your collection.
  </div>
{% endif %}

{% if request.query_params.get('added_existing') %}
  <div class="mb-3 text-xs rounded bg-slate-900/80 border border-slate-600/60 px-3 py-2">
    Increased quantity of <strong>{{ request.query_params.get('added_existing') }}</strong> in your collection.
  </div>
{% endif %}


{# Compact “manage collection” tools #}
<section class="bg-slate-800 rounded-lg p-3 mb-4">
  <h2 class="text-sm font-semibold mb-2 flex items-center gap-2">
    <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/20 border border-emerald-500/50 text-xs">⚙️</span>
    Manage my collection
  </h2>

  <div class="grid gap-2 sm:grid-cols-3">
    {# Tile: Import CSV #}
    <div class="bg-slate-900/70 rounded-md border border-slate-700 p-3">
      <button type="button"
              class="w-full flex items-center justify-between text-left"
              onclick="toggleDetails('collection-import-body')">
        <div>
          <div class="text-xs font-semibold text-slate-100">Import from CSV</div>
          <div class="text-[11px] text-slate-400">
            Upload Delver / other exports.
          </div>
        </div>
        <span class="text-slate-400 text-xs">Tap to open</span>
      </button>
      <div id="collection-import-body" class="mt-2 hidden">
        <form method="post"
              action="/dashboard/import-csv"
              enctype="multipart/form-data"
              class="mt-2 flex flex-col sm:flex-row gap-2 items-start sm:items-end"
              onsubmit="showImportLoading('collection-import-button','collection-import-status','Importing...')">
          <input type="file"
                 name="csv_file"
                 accept=".csv"
                 class="text-xs text-slate-200">
          <button type="submit"
                  id="collection-import-button"
                  class="px-3 py-1.5 rounded bg-emerald-500 hover:bg-emerald-400 text-slate-900 text-xs font-semibold">
            Import CSV to collection
          </button>
        </form>
        <p id="collection-import-status"
           class="hidden mt-1 text-[11px] text-slate-300">
          Importing cards from CSV... this may take a while if the file has many entries.
        </p>
      </div>
    </div>

    {# Tile: Add single card #}
    <div class="bg-slate-900/70 rounded-md border border-slate-700 p-3">
      <button type="button"
              class="w-full flex items-center justify-between text-left"
              onclick="toggleDetails('collection-add-single-body')">
        <div>
          <div class="text-xs font-semibold text-slate-100">Add a single card</div>
          <div class="text-[11px] text-slate-400">
            Quickly add one card by name.
          </div>
        </div>
        <span class="text-slate-400 text-xs">Tap to open</span>
      </button>
      <div id="collection-add-single-body" class="mt-2 hidden">
        <p class="text-[11px] text-slate-300 mb-2 mt-2">
          If you already have this card in your collection,
          its quantity will be increased instead of creating a duplicate row.
        </p>
        <form method="post" action="/collection/add-card"
              class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
          <div class="md:col-span-2">
            <label class="block text-xs mb-1">Card name</label>
            <div class="relative">
              <input id="collection-add-card-name"
                     name="card_name"
                     data-card-autocomplete="true"
                     class="w-full rounded bg-slate-900 border border-slate-600 px-3 py-2 text-sm"
                     placeholder="e.g. Sol Ring, Cyclonic Rift"
                     required>
              <div class="absolute z-30 mt-1 w-full bg-slate-900 border border-slate-700 rounded-md shadow-lg hidden text-xs max-h-56 overflow-y-auto"
                   data-card-suggestions-for="collection-add-card-name"></div>
            </div>
          </div>

          <div>
            <label class="block text-xs mb-1">Set (optional)</label>
            <input name="set_name"
                   class="w-full rounded bg-slate-900 border border-slate-600 px-3 py-2 text-sm"
                   placeholder="e.g. CMR">
          </div>

          <div>
            <label class="block text-xs mb-1">Quantity</label>
            <input type="number"
                   name="quantity"
                   min="1"
                   value="1"
                   class="w-full rounded bg-slate-900 border border-slate-600 px-3 py-2 text-sm">
          </div>

          <div class="md:col-span-4">
            <button type="submit"
                    class="px-4 py-2 rounded bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold text-sm">
              Add to collection
            </button>
          </div>
        </form>
      </div>
    </div>
    {# Tile: Delete whole collection #}
    <div class="bg-slate-900/70 rounded-md border border-rose-700 p-3">
      <div class="flex items-start justify-between">
        <div>
          <div class="text-xs font-semibold text-rose-300">Delete entire collection</div>
          <div class="text-[11px] text-slate-400 mt-0.5">
            Removes <strong>all cards</strong> from your collection. This cannot be undone.
          </div>
        </div>
      </div>

      <form method="post"
            action="/collection/clear"
            class="mt-3"
            onsubmit="return confirm('Are you sure you want to delete your entire collection? This cannot be undone.');">
        <button type="submit"
                class="w-full px-3 py-1.5 rounded bg-rose-600 hover:bg-rose-500 text-slate-50 text-xs font-semibold">
          Delete my entire collection
        </button>
      </form>
    </div>

  </div>
</section>


<details class="mb-4 bg-slate-800 rounded-lg">
  <summary class="px-3 py-2 text-sm cursor-pointer flex items-center justify-between">
    <span class="flex items-center gap-2">
      <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-slate-900 border border-slate-600 text-[11px]">⚙️</span>
      Filters & sorting
    </span>
    <span class="text-xs text-slate-400">Tap to open</span>
  </summary>

  <form method="get" action="/collection">
    <div class="px-4 pb-4 pt-3 border-t border-slate-700 text-sm space-y-4">

      {# Search bar #}
      <div>
        <label class="block text-xs mb-1 text-slate-300">Search by card name</label>
        <div class="relative">
          <input id="collection-q"
                 name="q"
                 value="{{ q or '' }}"
                 data-card-autocomplete="true"
                 class="w-full rounded bg-slate-900 border border-slate-600 px-3 py-2 text-sm"
                 placeholder="e.g. Lightning Bolt, Sol Ring">
          <div class="absolute z-30 mt-1 w-full bg-slate-900 border border-slate-700 rounded-md shadow-lg hidden text-xs max-h-56 overflow-y-auto"
               data-card-suggestions-for="collection-q"></div>
        </div>
      </div>

      {# Filters – two-column layout on desktop #}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        {# Listed status #}
        <div>
          <label class="block text-xs mb-1 text-slate-300">Listed status</label>
          <select name="listed"
                  class="w-full rounded bg-slate-900 border border-slate-600 px-3 py-2 text-sm">
            <option value="all" {% if listed == 'all' %}selected{% endif %}>All</option>
            <option value="listed" {% if listed == 'listed' %}selected{% endif %}>Listed only</option>
            <option value="not_listed" {% if listed == 'not_listed' %}selected{% endif %}>Not listed</option>
          </select>
        </div>

        {# Color – pill selector #}
        <div data-color-filter-group>
          <label class="block text-xs mb-1 text-slate-300">Color</label>
          <input type="hidden"
                 name="color"
                 data-color-hidden="true"
                 id="collection-color-input"
                 value="{{ color or 'any' }}">
          <div class="flex flex-wrap gap-1.5">
            {% set color_value = color or 'any' %}
            {% set colors = [
              ('any', 'Any'),
              ('W', 'W'),
              ('U', 'U'),
              ('B', 'B'),
              ('R', 'R'),
              ('G', 'G'),
              ('C', 'C')
            ] %}
            {% for code, label in colors %}
              {% set active = (color_value == code) %}
              <button type="button"
                      data-color-value="{{ code }}"
                      class="px-2 py-0.5 rounded-full border text-[11px]
                             {% if active %}
                               bg-emerald-500/30 border-emerald-400 text-emerald-50
                             {% else %}
                               bg-slate-900 border-slate-600 text-slate-200 hover:bg-slate-800
                             {% endif %}">
                {{ label }}
              </button>
            {% endfor %}
          </div>
        </div>

        {# Card type – pill selector (single-choice) #}
        <div data-type-filter-group>
          <label class="block text-xs mb-1 text-slate-300">Card type</label>
          <input type="hidden"
                 name="card_type"
                 data-type-hidden="true"
                 id="collection-type-input"
                 value="{{ card_type or 'any' }}">
          <div class="flex flex-wrap gap-1.5">
            {% set type_value = card_type or 'any' %}
            {% set types = [
              ('any', 'Any'),
              ('Creature', 'Creature'),
              ('Instant', 'Instant'),
              ('Sorcery', 'Sorcery'),
              ('Artifact', 'Artifact'),
              ('Enchantment', 'Enchantment'),
              ('Land', 'Land'),
              ('Planeswalker', 'Planeswalker')
            ] %}
            {% for value, label in types %}
              {% set active = (type_value == value) %}
              <button type="button"
                      data-type-value="{{ value }}"
                      class="px-2 py-0.5 rounded-full border text-[11px]
                             {% if active %}
                               bg-sky-500/30 border-sky-400 text-sky-50
                             {% else %}
                               bg-slate-900 border-slate-600 text-slate-200 hover:bg-slate-800
                             {% endif %}">
                {{ label }}
              </button>
            {% endfor %}
          </div>
        </div>

        {# Sort by – compact select #}
        <div>
          <label class="block text-xs mb-1 text-slate-300">Sort by</label>
          <select name="sort"
                  class="w-full rounded bg-slate-900 border border-slate-600 px-3 py-2 text-sm">
            <option value="name_asc"  {% if sort == 'name_asc' %}selected{% endif %}>Name A → Z</option>
            <option value="name_desc" {% if sort == 'name_desc' %}selected{% endif %}>Name Z → A</option>
            <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price high → low</option>
            <option value="price_asc"  {% if sort == 'price_asc' %}selected{% endif %}>Price low → high</option>
            <option value="set_asc"    {% if sort == 'set_asc' %}selected{% endif %}>Set, then name</option>
          </select>
        </div>

      </div>

      {# Apply + clear #}
      <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
        <button type="submit"
                class="w-full sm:w-auto px-4 py-2 rounded bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold text-sm">
          Apply filters
        </button>
        {% if has_filters %}
          <a href="/collection"
             class="w-full sm:w-auto px-4 py-2 rounded border border-slate-600 text-slate-200 text-xs text-center hover:bg-slate-800">
            Clear filters
          </a>
        {% endif %}
      </div>

    </div>
  </form>
</details>


{% if cards %}
  {# Bulk actions - collapsible #}
  <section class="bg-slate-800 rounded-lg p-3 mb-3">
    <button type="button"
            class="flex items-center justify-between w-full text-left text-xs text-slate-100"
            onclick="toggleDetails('collection-bulk-body')">
      <span class="flex items-center gap-2">
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-slate-700 text-[10px]">⚖️</span>
        Bulk listing actions
      </span>
      <span class="text-slate-400 text-[11px]">Tap to open</span>
    </button>

    <div id="collection-bulk-body" class="mt-2 hidden">
      <form method="post" action="/dashboard/bulk-list" id="collection-bulk-form"
            class="flex flex-wrap gap-2 items-center text-xs mt-2">
        <span class="text-slate-300 mr-1">With selected:</span>
        <button type="submit" name="action" value="list_selected"
                class="px-3 py-1.5 rounded bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold">
          List for trade
        </button>
        <button type="submit" name="action" value="unlist_selected"
                class="px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600 text-slate-100 font-semibold">
          Unlist
        </button>
        <button type="submit" name="action" value="list_all"
                class="px-3 py-1.5 rounded bg-emerald-700 hover:bg-emerald-600 text-slate-50 font-semibold">
          List all in my collection
        </button>
        <button type="submit" name="action" value="unlist_all"
                class="px-3 py-1.5 rounded bg-red-700 hover:bg-red-600 text-slate-50 font-semibold">
          Unlist all
        </button>
      </form>
    </div>
  </section>

{% if total %}
  <div class="text-xs text-slate-400 mb-2">
    Showing {{ cards|length }} of {{ total }} card{% if total != 1 %}s{% endif %} in your collection.
    Page {{ page }} of {{ max_page }}.
  </div>
{% endif %}

  <div class="max-h-[480px] overflow-y-auto border border-slate-700 rounded-md">
    <div class="overflow-x-auto">
      <table class="min-w-full text-xs">
        <thead class="bg-slate-900 sticky top-0">
          <tr>
            <th class="px-2 py-2 w-8 text-left"></th>
            <th class="px-2 py-2 text-left">Card</th>
            <th class="px-2 py-2 text-left hidden sm:table-cell">Set</th>
            <th class="px-2 py-2 text-left">Qty</th>
            <th class="px-2 py-2 text-left hidden sm:table-cell">Listed?</th>
            <th class="px-2 py-2 text-right">Value</th>
            <th class="px-2 py-2 w-8 text-right"></th>
          </tr>
        </thead>
        <tbody>
        {% for item in view_cards %}
          {% set c = item.card %}
          {% set mana = item.mana %}
          <!-- main row -->
          <tr class="border-t border-slate-700 bg-slate-900/60 hover:bg-slate-900 align-top">
            <td class="px-2 py-1">
              <input type="checkbox" name="card_ids" value="{{ c.id }}"
                    form="collection-bulk-form"
                    class="accent-emerald-500">
            </td>
            <td class="px-2 py-1">
              <div class="flex flex-col gap-0.5">
                {% if c.scryfall_image_url %}
                  <div class="font-semibold text-slate-100 text-[11px] cursor-pointer"
                      onclick="openCardModal('{{ c.scryfall_image_url }}', '{{ c.card_name|e }}')">
                    {{ c.card_name }}
                  </div>
                  {% if c.card_name in wishlist_names %}
                    <div class="text-[10px] text-amber-300 mt-0.5">
                      This card is on your wishlist.
                    </div>
                  {% endif %}
                {% else %}
                  <div class="font-semibold text-slate-100 text-[11px]">
                    {{ c.card_name }}
                  </div>
                {% endif %}
                {% if c.type_line %}
                  <div class="text-[10px] text-slate-400">
                    {{ c.type_line }}
                  </div>
                {% endif %}
                <div class="sm:hidden mt-1">
                  {% if c.is_for_trade %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-emerald-600/30 text-emerald-300 text-[10px]">
                      listed
                    </span>
                  {% else %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-700 text-slate-300 text-[10px]">
                      not listed
                    </span>
                  {% endif %}
                </div>
              </div>
            </td>
            <td class="px-2 py-1 hidden sm:table-cell">
              {% if c.set_name %}
                <span class="text-[11px] text-slate-300">{{ c.set_name }}</span>
              {% else %}
                <span class="text-[11px] text-slate-500">—</span>
              {% endif %}
            </td>
            <td class="px-2 py-1">
              <span class="text-[11px] text-slate-200">{{ c.quantity }}</span>
            </td>
            <td class="px-2 py-1 hidden sm:table-cell">
              {% if c.is_for_trade %}
                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-emerald-600/30 text-emerald-300 text-[10px]">
                  listed
                </span>
              {% else %}
                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-700 text-slate-300 text-[10px]">
                  not listed
                </span>
              {% endif %}
            </td>
            <td class="px-2 py-1 text-right">
              {% if c.price_usd %}
                <span class="text-[11px] text-emerald-300">
                  ~${{ "%.2f"|format(c.price_usd) }}
                  {% if c.quantity > 1 %}
                    · ~${{ "%.2f"|format(c.price_usd * c.quantity) }}
                  {% endif %}
                </span>
              {% else %}
                <span class="text-[11px] text-slate-500">n/a</span>
              {% endif %}
            </td>
            <td class="px-2 py-1 text-right align-top">
              <div class="relative inline-block text-left">
                <button type="button"
                        class="inline-flex items-center justify-center rounded-full w-6 h-6 text-slate-300 hover:bg-slate-700"
                        onclick="toggleRowMenu('collection-menu-{{ c.id }}', event)">
                  ⋮
                </button>
                <div id="collection-menu-{{ c.id }}"
                     class="hidden absolute right-0 mt-1 w-48 bg-slate-900 border border-slate-700 rounded-md shadow-lg z-20 px-3 py-2">
                  <form method="post"
                        action="/collection/delete-card"
                        onsubmit="return confirm('Remove these copies of {{ c.card_name|e }} from your collection?');"
                        class="space-y-1 text-[11px] text-slate-100">
                    <input type="hidden" name="card_id" value="{{ c.id }}">
                    <div class="text-slate-300 mb-1">
                      Remove from collection
                    </div>
                    <label class="block text-[10px] text-slate-400 mb-1">
                      Number of copies to remove:
                    </label>
                    <input type="number"
                           name="quantity"
                           min="1"
                           max="{{ c.quantity }}"
                           value="1"
                           class="w-full rounded bg-slate-800 border border-slate-600 px-2 py-1 text-[11px] text-right">
                    <button type="submit"
                            class="mt-1 w-full px-2 py-1 rounded bg-rose-600 hover:bg-rose-500 text-slate-50 text-[11px] font-semibold">
                      Remove
                    </button>
                  </form>
                </div>
              </div>
            </td>

          </tr>
        {% endfor %}


        </tbody>
      </table>
    </div>
  </div>

  {% if max_page > 1 %}
    <div class="flex justify-between items-center mt-3 text-xs text-slate-300">
      <div>
        {% if page > 1 %}
          <a href="/collection?q={{ q|urlencode }}&listed={{ listed }}&color={{ color }}&card_type={{ card_type }}&sort={{ sort }}&page={{ page - 1 }}"
             class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700">
            ‹ Previous
          </a>
        {% endif %}
      </div>
      <div>
        Page {{ page }} of {{ max_page }}
      </div>
      <div>
        {% if page < max_page %}
          <a href="/collection?q={{ q|urlencode }}&listed={{ listed }}&color={{ color }}&card_type={{ card_type }}&sort={{ sort }}&page={{ page + 1 }}"
             class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700">
            Next ›
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}
{% else %}
  <p class="text-sm text-slate-400">
    No cards in your collection match this filter.
  </p>
{% endif %}
{% endblock %}
