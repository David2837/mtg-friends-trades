<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}MTG Friends Trades{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
  .nav-link {
    padding: 0.25rem 0.5rem;
    white-space: nowrap;
  }
  </style>
</head>
<script>
  async function fetchCardSuggestions(query) {
    if (!query || query.length < 2) return [];
    try {
      const resp = await fetch(`/api/card-suggestions?q=${encodeURIComponent(query)}`);
      if (!resp.ok) return [];
      const data = await resp.json();
      return data.suggestions || [];
    } catch (e) {
      return [];
    }
  }

  function attachCardAutocomplete(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;

    // Find or create a dropdown container right after the input
    let dropdown = document.getElementById(inputId + "-suggestions");
    if (!dropdown) {
      dropdown = document.createElement("div");
      dropdown.id = inputId + "-suggestions";
      dropdown.className = "absolute z-30 mt-1 w-full bg-slate-800 border border-slate-600 rounded-md shadow-lg text-sm hidden";
      input.parentNode.style.position = "relative";
      input.parentNode.appendChild(dropdown);
    }

    let lastQuery = "";
    let hideTimeout = null;

    input.addEventListener("input", async () => {
      const q = input.value.trim();
      lastQuery = q;
      if (q.length < 2) {
        dropdown.classList.add("hidden");
        return;
      }

      const suggestions = await fetchCardSuggestions(q);
      if (q !== lastQuery) return; // ignore stale responses

      if (!suggestions.length) {
        dropdown.classList.add("hidden");
        return;
      }

      dropdown.innerHTML = "";
      suggestions.forEach(name => {
        const item = document.createElement("div");
        item.textContent = name;
        item.className = "px-3 py-1.5 cursor-pointer hover:bg-slate-700";
        item.addEventListener("mousedown", (e) => {
          e.preventDefault();
          input.value = name;
          dropdown.classList.add("hidden");
        });
        dropdown.appendChild(item);
      });
      dropdown.classList.remove("hidden");
    });

    input.addEventListener("blur", () => {
      hideTimeout = setTimeout(() => {
        dropdown.classList.add("hidden");
      }, 150);
    });

    input.addEventListener("focus", () => {
      if (hideTimeout) {
        clearTimeout(hideTimeout);
        hideTimeout = null;
      }
      if (dropdown.children.length > 0) {
        dropdown.classList.remove("hidden");
      }
    });
  }
  function toggleDetails(elId) {
    const el = document.getElementById(elId);
    if (!el) return;
    el.classList.toggle("hidden");
  }
  // Initialize on DOM ready for known inputs (if present on page)
  document.addEventListener("DOMContentLoaded", () => {
    attachCardAutocomplete("add-card-name");
    attachCardAutocomplete("wishlist-card-name");
    attachCardAutocomplete("search-card-name");
  });
</script>
<body class="bg-slate-900 text-slate-100 min-h-screen">
<header class="bg-slate-950 border-b border-slate-800">
  <div class="max-w-5xl mx-auto px-4 py-3">
    <div class="flex items-center justify-between gap-4">
      <!-- Left: logo -->
      <a href="/" class="font-bold text-lg leading-tight whitespace-nowrap">
        <span class="text-emerald-400">MTG</span>
        <span class="text-slate-100"> Friend Trades</span>
      </a>

      <!-- Middle: main nav (logged in) -->
      {% if current_user %}
        <nav class="hidden md:flex flex-wrap gap-x-3 gap-y-2 text-sm">
          <a href="/dashboard"
             class="nav-link {% if request.url.path.startswith('/dashboard') %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
            Wishlist
          </a>
          <a href="/collection"
             class="nav-link {% if request.url.path.startswith('/collection') %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
            Collection
          </a>
          <a href="/cards"
             class="nav-link {% if request.url.path.startswith('/cards') %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
            Browse
          </a>
          <a href="/matches"
             class="nav-link {% if request.url.path.startswith('/matches') %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
            Matches
          </a>
          <a href="/trade-plan"
             class="nav-link {% if request.url.path.startswith('/trade-plan') %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
            Trade plan
          </a>
          <a href="/groups"
             class="nav-link {% if request.url.path.startswith('/groups') %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
            Groups
          </a>
        </nav>
      {% endif %}

      <!-- Right: profile / auth -->
      <div class="flex items-center gap-3">
        {% if current_user %}
          <!-- Profile dropdown -->
          <details class="relative">
            <summary class="cursor-pointer list-none flex items-center gap-2 text-xs text-slate-200">
              <span class="hidden sm:inline">
                {{ current_user.name }}
              </span>
              <span class="inline-flex sm:hidden w-7 h-7 rounded-full bg-slate-800 items-center justify-center text-[11px]">
                {{ current_user.name[:2]|upper }}
              </span>
              <span class="text-[10px] text-slate-400">â–¾</span>
            </summary>
            <div class="absolute right-0 mt-2 w-40 rounded bg-slate-900 border border-slate-700 shadow-lg z-50">
              <a href="/profile"
                 class="block px-3 py-2 text-xs text-slate-100 hover:bg-slate-800">
                Profile
              </a>
              <form method="post" action="/logout">
                <button class="w-full text-left px-3 py-2 text-xs text-rose-300 hover:bg-slate-800">
                  Logout
                </button>
              </form>
            </div>
          </details>
        {% else %}
          <a href="/signup"
             class="px-3 py-1.5 rounded text-xs text-slate-200 border border-emerald-500/60 hover:bg-emerald-500 hover:text-slate-900">
            Sign up
          </a>
          <a href="/login"
             class="px-3 py-1.5 rounded text-xs text-slate-200 border border-slate-600 hover:bg-slate-800">
            Login
          </a>
        {% endif %}
      </div>
    </div>

    <!-- Optional: small nav row for mobile when logged in -->
    {% if current_user %}
      <nav class="mt-3 flex md:hidden flex-wrap gap-x-3 gap-y-2 text-sm">
        <a href="/dashboard"
           class="nav-link {% if request.url.path.startswith('/dashboard') %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
          Wishlist
        </a>
        <a href="/collection"
           class="nav-link {% if request.url.path.startswith('/collection') %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
          Collection
        </a>
        <a href="/cards"
           class="nav-link {% if request.url.path.startswith('/cards') %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
          Browse
        </a>
        <a href="/matches"
           class="nav-link {% if request.url.path.startswith('/matches') %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
          Matches
        </a>
        <a href="/trade-plan"
           class="nav-link {% if request.url.path.startswith('/trade-plan') %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
          Trade plan
        </a>
        <a href="/groups"
           class="nav-link {% if request.url.path.startswith('/groups') %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
          Groups
        </a>
      </nav>
    {% else %}
      <nav class="mt-3 flex flex-wrap gap-x-3 gap-y-2 text-sm">
        <a href="/"
           class="nav-link {% if request.url.path == '/' %}bg-slate-800 text-emerald-300{% else %}text-slate-200 hover:bg-slate-800{% endif %}">
          Home
        </a>
      </nav>
    {% endif %}
  </div>
</header>
<main class="max-w-5xl mx-auto px-4 py-6">
  {% block content %}{% endblock %}
</main>
<script>
function postClaim(cardId) {
  fetch("/claims/create", {
    method: "POST",
    headers: { 
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: "card_id=" + cardId
  }).then(() => {
    location.reload();
  });
}
</script>
<!-- Card preview modal -->
<div id="card-modal" class="fixed inset-0 z-40 hidden">
  <!-- dark overlay: clicking here closes -->
  <div class="absolute inset-0 bg-black/70" onclick="closeCardModal()"></div>

  <!-- centered card -->
  <div class="relative z-50 flex items-center justify-center min-h-full p-4">
    <div class="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl p-3 max-w-sm w-full">
      <div class="flex justify-end mb-1">
        <button type="button"
                onclick="closeCardModal()"
                class="text-slate-300 hover:text-white text-xl leading-none px-2">
          &times;
        </button>
      </div>
      <div class="flex justify-center">
        <img id="card-modal-img"
             src=""
             alt=""
             class="max-h-[80vh] w-auto rounded-lg shadow-xl border border-slate-700">
      </div>
      <div id="card-modal-title"
           class="mt-2 text-center text-sm text-slate-100"></div>
    </div>
  </div>
</div>

<script>
  function openCardModal(url, title) {
    const modal = document.getElementById('card-modal');
    const img = document.getElementById('card-modal-img');
    const titleEl = document.getElementById('card-modal-title');
    if (!modal || !img) return;
    img.src = url;
    img.alt = title || '';
    if (titleEl) {
      titleEl.textContent = title || '';
    }
    modal.classList.remove('hidden');
  }

  function closeCardModal() {
    const modal = document.getElementById('card-modal');
    if (!modal) return;
    modal.classList.add('hidden');
  }

  // allow ESC to close
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
      closeCardModal();
    }
  });

  // ---- Card name autocomplete (Scryfall) ----
  async function fetchCardSuggestions(query) {
    if (!query || query.length < 2) {
      return [];
    }
    try {
      const res = await fetch('/api/card-autocomplete?q=' + encodeURIComponent(query));
      if (!res.ok) return [];
      const data = await res.json();
      return data.suggestions || [];
    } catch (e) {
      return [];
    }
  }

  function attachCardAutocomplete(input) {
    const inputId = input.id;
    if (!inputId) return;

    const dropdown = document.querySelector(
      '[data-card-suggestions-for="' + inputId + '"]'
    );
    if (!dropdown) return;

    let lastValue = '';
    let currentSuggestions = [];

    function hideDropdown() {
      dropdown.classList.add('hidden');
    }

    function showDropdown() {
      if (!currentSuggestions.length) {
        hideDropdown();
        return;
      }
      dropdown.classList.remove('hidden');
    }

    input.addEventListener('input', async function () {
      const value = input.value.trim();
      lastValue = value;

      if (value.length < 2) {
        currentSuggestions = [];
        hideDropdown();
        return;
      }

      const suggestions = await fetchCardSuggestions(value);
      // avoid race conditions
      if (input.value.trim() !== lastValue) {
        return;
      }

      currentSuggestions = suggestions;
      dropdown.innerHTML = '';

      if (!suggestions.length) {
        hideDropdown();
        return;
      }

      suggestions.forEach(function (name) {
        const item = document.createElement('div');
        item.textContent = name;
        item.className =
          'px-2 py-1 hover:bg-slate-700 cursor-pointer text-slate-100 text-xs';
        item.addEventListener('mousedown', function (e) {
          e.preventDefault(); // prevent blur
          input.value = name;
          hideDropdown();
        });
        dropdown.appendChild(item);
      });

      showDropdown();
    });

    input.addEventListener('blur', function () {
      setTimeout(hideDropdown, 150);
    });

    input.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        hideDropdown();
        input.blur();
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    const inputs = document.querySelectorAll('[data-card-autocomplete="true"]');
    inputs.forEach(attachCardAutocomplete);
  });

function showImportLoading(buttonId, statusId, loadingText) {
    const btn = document.getElementById(buttonId);
    const status = document.getElementById(statusId);
    if (btn) {
      btn.disabled = true;
      if (loadingText) {
        btn.textContent = loadingText;
      }
      btn.classList.add('opacity-70', 'cursor-not-allowed');
    }
    if (status) {
      status.classList.remove('hidden');
    }
  }

</script>
</body>
</html>

</body>
</html>
